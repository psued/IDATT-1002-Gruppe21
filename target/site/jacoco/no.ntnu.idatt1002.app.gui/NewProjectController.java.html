<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>NewProjectController.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">IDATT1002Project</a> &gt; <a href="index.source.html" class="el_package">no.ntnu.idatt1002.app.gui</a> &gt; <span class="el_source">NewProjectController.java</span></div><h1>NewProjectController.java</h1><pre class="source lang-java linenums">package no.ntnu.idatt1002.app.gui;

import java.io.IOException;
import java.time.LocalDate;
import java.util.ArrayList;
import java.util.List;
import java.util.Objects;
import java.util.Optional;
import javafx.fxml.FXML;
import javafx.fxml.FXMLLoader;
import javafx.scene.Parent;
import javafx.scene.control.Alert;
import javafx.scene.control.Button;
import javafx.scene.control.ButtonType;
import javafx.scene.control.DatePicker;
import javafx.scene.control.Label;
import javafx.scene.control.MenuButton;
import javafx.scene.control.MenuItem;
import javafx.scene.control.TableColumn;
import javafx.scene.control.TableView;
import javafx.scene.control.TextArea;
import javafx.scene.control.TextField;
import javafx.scene.control.cell.PropertyValueFactory;
import javafx.scene.input.KeyCode;
import javafx.scene.input.KeyEvent;
import javafx.scene.text.Text;
import no.ntnu.idatt1002.app.BudgetAndAccountingApp;
import no.ntnu.idatt1002.app.data.Expense;
import no.ntnu.idatt1002.app.data.Income;
import no.ntnu.idatt1002.app.data.Project;
import no.ntnu.idatt1002.app.data.Transaction;
import no.ntnu.idatt1002.app.data.User;
import no.ntnu.idatt1002.app.filehandling.FileHandling;

/**
 * FXML Controller class for the New Project page. Only mandatory field is the name of the project.
 */
<span class="nc" id="L38">public class NewProjectController {</span>
  
  private User tempUser;
  
  // Local Accounting overview
<span class="nc" id="L43">  private final ArrayList&lt;Income&gt; accountingIncome = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L44">  private final ArrayList&lt;Expense&gt; accountingExpense = new ArrayList&lt;&gt;();</span>
  
  // Local Budgeting overview
<span class="nc" id="L47">  private final ArrayList&lt;Income&gt; budgetingIncome = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L48">  private final ArrayList&lt;Expense&gt; budgetingExpense = new ArrayList&lt;&gt;();</span>
  
  // Fundamental project information
  @FXML private TextField name;
  @FXML private MenuButton category;
  @FXML private TextArea description;
  @FXML private DatePicker dueDate;
  
  //Accounting and Budgeting buttons
  @FXML private Button accounting;
  @FXML private Button budgeting;
  
  //Selected transaction status
<span class="nc" id="L61">  private boolean isAccounting = true;</span>
<span class="nc" id="L62">  private Transaction selectedTransaction = null;</span>
  
  //Income Table
  @FXML private TableView&lt;Income&gt; incomeTable;
  @FXML private TableColumn&lt;Income, LocalDate&gt; incomeDate;
  @FXML private TableColumn&lt;Income, String&gt; incomeDescription;
  @FXML private TableColumn&lt;Income, String&gt; incomeCategory;
  @FXML private TableColumn&lt;Income, Double&gt; incomeAmount;
  //Income fields
  @FXML private DatePicker incomeDatePicker;
  @FXML private TextField incomeDescriptionField;
  @FXML private TextField incomeCategoryField;
  @FXML private TextField incomeAmountField;
  
  //Expense Table
  @FXML private TableView&lt;Expense&gt; expenseTable;
  @FXML private TableColumn&lt;Expense, LocalDate&gt; expenseDate;
  @FXML private TableColumn&lt;Expense, String&gt; expenseDescription;
  @FXML private TableColumn&lt;Expense, String&gt; expenseCategory;
  @FXML private TableColumn&lt;Expense, Double&gt; expenseAmount;
  //Expense fields
  @FXML private DatePicker expenseDatePicker;
  @FXML private TextField expenseDescriptionField;
  @FXML private TextField expenseCategoryField;
  @FXML private TextField expenseAmountField;
  
  //Total income, expense and amount overview
  @FXML private Text totalIncome;
  @FXML private Text totalExpense;
  @FXML private Text totalAmount;
  
  //Error message
<span class="nc" id="L94">  @FXML private final Label nameError = new Label();</span>
  
  /**
   * Initializes the controller class.
   */
  public void initialize() {
    try {
<span class="nc" id="L101">      tempUser = FileHandling.readUserFromFile();</span>
<span class="nc" id="L102">    } catch (IOException e) {</span>
<span class="nc" id="L103">      e.printStackTrace();</span>
<span class="nc" id="L104">    } catch (ClassNotFoundException e) {</span>
<span class="nc" id="L105">      throw new RuntimeException(e);</span>
    }
    
<span class="nc" id="L108">    category.getItems().clear();</span>
  
<span class="nc bnc" id="L110" title="All 2 branches missed.">    for (String category : tempUser.getProjectRegistry().getCategories()) {</span>
<span class="nc" id="L111">      MenuItem menuItem = new MenuItem(category);</span>
<span class="nc" id="L112">      menuItem.setOnAction(event -&gt; this.category.setText(menuItem.getText()));</span>
<span class="nc" id="L113">      this.category.getItems().add(menuItem);</span>
    }
    
<span class="nc" id="L116">    accounting.setStyle(&quot;-fx-border-color: #000000&quot;);</span>
    
    // Accounting table
<span class="nc" id="L119">    incomeDate.setCellValueFactory(new PropertyValueFactory&lt;&gt;(&quot;date&quot;));</span>
<span class="nc" id="L120">    incomeDescription.setCellValueFactory(new PropertyValueFactory&lt;&gt;(&quot;description&quot;));</span>
<span class="nc" id="L121">    incomeCategory.setCellValueFactory(new PropertyValueFactory&lt;&gt;(&quot;category&quot;));</span>
<span class="nc" id="L122">    incomeAmount.setCellValueFactory(new PropertyValueFactory&lt;&gt;(&quot;amount&quot;));</span>
    
    // Budgeting table
<span class="nc" id="L125">    expenseDate.setCellValueFactory(new PropertyValueFactory&lt;&gt;(&quot;date&quot;));</span>
<span class="nc" id="L126">    expenseDescription.setCellValueFactory(new PropertyValueFactory&lt;&gt;(&quot;description&quot;));</span>
<span class="nc" id="L127">    expenseCategory.setCellValueFactory(new PropertyValueFactory&lt;&gt;(&quot;category&quot;));</span>
<span class="nc" id="L128">    expenseAmount.setCellValueFactory(new PropertyValueFactory&lt;&gt;(&quot;amount&quot;));</span>
    
    
<span class="nc" id="L131">    nameError.setVisible(false);</span>
<span class="nc" id="L132">  }</span>
  
  /**
   * Toggle to accounting view, makes the accounting button style look active. Updates the
   * isAccounting boolean so that when a table is changed, the correct table is updated.
   */
  public void toggleAccounting() {
<span class="nc" id="L139">    accounting.setStyle(&quot;-fx-border-color: #000000&quot;);</span>
<span class="nc" id="L140">    budgeting.setStyle(&quot;-fx-border-color: none&quot;);</span>
<span class="nc" id="L141">    isAccounting = true;</span>
    
<span class="nc" id="L143">    refreshLocalOverview();</span>
<span class="nc" id="L144">  }</span>
  
  /**
   * Toggle to budgeting view, makes the budgeting button style look active. Updates the
   * isAccounting boolean so that when a table is changed, the correct table is updated.
   */
  public void toggleBudgeting() {
<span class="nc" id="L151">    budgeting.setStyle(&quot;-fx-border-color: #000000&quot;);</span>
<span class="nc" id="L152">    accounting.setStyle(&quot;-fx-border-color: none&quot;);</span>
<span class="nc" id="L153">    isAccounting = false;</span>
    
<span class="nc" id="L155">    refreshLocalOverview();</span>
<span class="nc" id="L156">  }</span>
  
  /**
   * Checks if the user has selected an income and if so, it will input the income values into
   * the income fields. If the user has clicked an empty row or the same row twice, the income
   * fields will be reset.
   *
   * &lt;p&gt;Clicking an income row will also update the selectedTransaction variable which has the
   * effect of updating the chosen income rather than creating a new one.
   */
  public void selectedIncome() {
<span class="nc bnc" id="L167" title="All 2 branches missed.">    if (incomeTable.getSelectionModel().getSelectedItem() != selectedTransaction) {</span>
<span class="nc" id="L168">      selectedTransaction = incomeTable.getSelectionModel().getSelectedItem();</span>
<span class="nc bnc" id="L169" title="All 2 branches missed.">      incomeDatePicker.setValue(selectedTransaction.getDate() == null</span>
<span class="nc" id="L170">          ? null : selectedTransaction.getDate());</span>
<span class="nc" id="L171">      incomeDescriptionField.setText(selectedTransaction.getDescription());</span>
<span class="nc" id="L172">      incomeCategoryField.setText(selectedTransaction.getCategory());</span>
<span class="nc" id="L173">      incomeAmountField.setText(String.valueOf(selectedTransaction.getAmount()));</span>
<span class="nc" id="L174">    } else {</span>
<span class="nc" id="L175">      incomeTable.getSelectionModel().clearSelection();</span>
<span class="nc" id="L176">      selectedTransaction = null;</span>
<span class="nc" id="L177">      resetIncomeFields();</span>
    }
<span class="nc" id="L179">  }</span>
  
  /**
   * Checks if the user has selected an expense and if so, it will input the expense values into
   * the expense fields. If the user has clicked an empty row or the same row twice, the expense
   * fields will be reset.
   *
   * &lt;p&gt;Clicking an expense row will also update the selectedTransaction variable which has the
   * effect of updating the chosen expense rather than creating a new one.
   */
  public void selectedExpense() {
<span class="nc bnc" id="L190" title="All 2 branches missed.">    if (expenseTable.getSelectionModel().getSelectedItem() != selectedTransaction) {</span>
<span class="nc" id="L191">      selectedTransaction = expenseTable.getSelectionModel().getSelectedItem();</span>
<span class="nc bnc" id="L192" title="All 2 branches missed.">      expenseDatePicker.setValue(selectedTransaction.getDate() == null</span>
<span class="nc" id="L193">          ? null : selectedTransaction.getDate());</span>
<span class="nc" id="L194">      expenseDescriptionField.setText(selectedTransaction.getDescription());</span>
<span class="nc" id="L195">      expenseCategoryField.setText(selectedTransaction.getCategory());</span>
<span class="nc" id="L196">      expenseAmountField.setText(String.valueOf(selectedTransaction.getAmount()));</span>
<span class="nc" id="L197">    } else {</span>
<span class="nc" id="L198">      expenseTable.getSelectionModel().clearSelection();</span>
<span class="nc" id="L199">      selectedTransaction = null;</span>
<span class="nc" id="L200">      resetExpenseFields();</span>
    }
<span class="nc" id="L202">  }</span>
  
  /**
   * When pressing the add button, the addIncomeToLocal method will be called and depending on
   * whether a row is selected or not, the income will be added or updated.
   */
  public void addIncomeToLocal() {
    try {
<span class="nc bnc" id="L210" title="All 2 branches missed.">      List&lt;Income&gt; incomeList = isAccounting ? accountingIncome : budgetingIncome;</span>
<span class="nc bnc" id="L211" title="All 2 branches missed.">      if (selectedTransaction != null) {</span>
<span class="nc" id="L212">        incomeList.remove(((Income) selectedTransaction));</span>
      }
<span class="nc" id="L214">      incomeList.add(new Income(incomeDescriptionField.getText(), incomeCategoryField.getText(),</span>
<span class="nc" id="L215">          Double.parseDouble(incomeAmountField.getText()), incomeDatePicker.getValue()));</span>
      
<span class="nc" id="L217">      refreshLocalOverview();</span>
<span class="nc" id="L218">      resetIncomeFields();</span>
      
<span class="nc" id="L220">    } catch (NumberFormatException e) {</span>
<span class="nc" id="L221">      nameError.setText(&quot;Please enter a valid amount&quot;);</span>
<span class="nc" id="L222">      nameError.setVisible(true);</span>
<span class="nc" id="L223">    } catch (IllegalArgumentException e) {</span>
<span class="nc" id="L224">      nameError.setText(e.getMessage());</span>
<span class="nc" id="L225">      nameError.setVisible(true);</span>
    }
<span class="nc" id="L227">  }</span>
  
  /**
   * When pressing the add button, the addExpenseToLocal method will be called and depending on
   * whether a row is selected or not, the expense will be added or updated.
   */
  public void addExpenseToLocal() {
    try {
<span class="nc bnc" id="L235" title="All 2 branches missed.">      List&lt;Expense&gt; expenseList = isAccounting ? accountingExpense : budgetingExpense;</span>
<span class="nc bnc" id="L236" title="All 2 branches missed.">      if (selectedTransaction != null) {</span>
<span class="nc" id="L237">        expenseList.remove((Expense) selectedTransaction);</span>
      }
<span class="nc" id="L239">      expenseList.add(new Expense(expenseDescriptionField.getText(), expenseCategoryField.getText(),</span>
<span class="nc" id="L240">          Double.parseDouble(expenseAmountField.getText()), expenseDatePicker.getValue()));</span>
      
<span class="nc" id="L242">      refreshLocalOverview();</span>
<span class="nc" id="L243">      resetExpenseFields();</span>
      
<span class="nc" id="L245">    } catch (NumberFormatException e) {</span>
<span class="nc" id="L246">      nameError.setText(&quot;Please enter a valid amount&quot;);</span>
<span class="nc" id="L247">      nameError.setVisible(true);</span>
<span class="nc" id="L248">    } catch (IllegalArgumentException e) {</span>
<span class="nc" id="L249">      nameError.setText(e.getMessage());</span>
<span class="nc" id="L250">      nameError.setVisible(true);</span>
    }
<span class="nc" id="L252">  }</span>
  
  /**
   * Removes a transaction from the local overview when the delete or backspace key is pressed.
   * Checks if the overview is set to accounting or budgeting.
   */
  @FXML
  public void removeTransaction(KeyEvent event) {
<span class="nc bnc" id="L260" title="All 4 branches missed.">    if (event.getCode() == KeyCode.DELETE || event.getCode() == KeyCode.BACK_SPACE) {</span>
      
<span class="nc bnc" id="L262" title="All 2 branches missed.">      List&lt;? extends Transaction&gt; transactionList = isAccounting</span>
<span class="nc bnc" id="L263" title="All 2 branches missed.">          ? (selectedTransaction instanceof Income ? accountingIncome : accountingExpense)</span>
<span class="nc bnc" id="L264" title="All 2 branches missed.">          : (selectedTransaction instanceof Income ? budgetingIncome : budgetingExpense);</span>
      
<span class="nc bnc" id="L266" title="All 2 branches missed.">      if (selectedTransaction != null) {</span>
<span class="nc" id="L267">        transactionList.remove(selectedTransaction);</span>
      }
      
<span class="nc" id="L270">      refreshLocalOverview();</span>
    }
<span class="nc" id="L272">  }</span>
  
  /**
   * Refreshes the local overview by updating the tables and totals, resetting the selected row
   * and resets the error message.
   */
  private void refreshLocalOverview() {
<span class="nc" id="L279">    selectedTransaction = null;</span>
    
    // Update tables
<span class="nc" id="L282">    incomeTable.getItems().clear();</span>
<span class="nc" id="L283">    expenseTable.getItems().clear();</span>
    
<span class="nc bnc" id="L285" title="All 2 branches missed.">    incomeTable.getItems().addAll(isAccounting ? accountingIncome : budgetingIncome);</span>
<span class="nc bnc" id="L286" title="All 2 branches missed.">    expenseTable.getItems().addAll(isAccounting ? accountingExpense : budgetingExpense);</span>
    
<span class="nc" id="L288">    incomeTable.refresh();</span>
<span class="nc" id="L289">    expenseTable.refresh();</span>
  
    // Update totals
<span class="nc bnc" id="L292" title="All 2 branches missed.">    double incomeAmount = isAccounting ? accountingIncome.stream().mapToDouble(Income::getAmount)</span>
<span class="nc" id="L293">        .sum() : budgetingIncome.stream().mapToDouble(Income::getAmount).sum();</span>
<span class="nc bnc" id="L294" title="All 2 branches missed.">    double expenseAmount = isAccounting ? accountingExpense.stream().mapToDouble(Expense::getAmount)</span>
<span class="nc" id="L295">        .sum() : budgetingExpense.stream().mapToDouble(Expense::getAmount).sum();</span>
  
<span class="nc" id="L297">    totalIncome.setText(String.format(&quot;%.2f kr&quot;, incomeAmount));</span>
<span class="nc" id="L298">    totalExpense.setText(String.format(&quot;- %.2f kr&quot;, expenseAmount));</span>
<span class="nc" id="L299">    totalAmount.setText(String.format(&quot;%.2f kr&quot;, incomeAmount - expenseAmount));</span>
    
    // Reset error message
<span class="nc" id="L302">    nameError.setVisible(false);</span>
<span class="nc" id="L303">    nameError.setText(&quot;&quot;);</span>
<span class="nc" id="L304">  }</span>
  
  // Resets the income fields
  private void resetIncomeFields() {
<span class="nc" id="L308">    incomeDatePicker.setValue(null);</span>
<span class="nc" id="L309">    incomeDescriptionField.setText(&quot;&quot;);</span>
<span class="nc" id="L310">    incomeCategoryField.setText(&quot;&quot;);</span>
<span class="nc" id="L311">    incomeAmountField.setText(&quot;&quot;);</span>
<span class="nc" id="L312">  }</span>
  
  // Resets the expense fields
  private void resetExpenseFields() {
<span class="nc" id="L316">    expenseDatePicker.setValue(null);</span>
<span class="nc" id="L317">    expenseDescriptionField.setText(&quot;&quot;);</span>
<span class="nc" id="L318">    expenseCategoryField.setText(&quot;&quot;);</span>
<span class="nc" id="L319">    expenseAmountField.setText(&quot;&quot;);</span>
<span class="nc" id="L320">  }</span>
  
  /**
   * Creates a new project and adds it to the user's project registry. It will display an error
   * message if the project name is invalid.
   */
  public void saveProject() {
    try {
<span class="nc" id="L328">      Project project = new Project(name.getText(), description.getText(), category.getText(),</span>
<span class="nc" id="L329">          dueDate.getValue());</span>
      
<span class="nc" id="L331">      accountingIncome.forEach(project.getAccounting()::addIncome);</span>
<span class="nc" id="L332">      accountingExpense.forEach(project.getAccounting()::addExpense);</span>
<span class="nc" id="L333">      budgetingIncome.forEach(project.getBudgeting()::addIncome);</span>
<span class="nc" id="L334">      budgetingExpense.forEach(project.getBudgeting()::addExpense);</span>
      
<span class="nc" id="L336">      tempUser.addProject(project);</span>
      
     
      try {
<span class="nc" id="L340">        FileHandling.writeUserToFile(tempUser);</span>
        
<span class="nc" id="L342">        Parent root = FXMLLoader.load(</span>
<span class="nc" id="L343">            Objects.requireNonNull(getClass().getResource(&quot;/AllProjects.fxml&quot;)));</span>
<span class="nc" id="L344">        BudgetAndAccountingApp.setRoot(root);</span>
<span class="nc" id="L345">      } catch (IOException e) {</span>
<span class="nc" id="L346">        e.printStackTrace();</span>
      }
      
<span class="nc" id="L349">    } catch (IllegalArgumentException e) {</span>
<span class="nc" id="L350">      nameError.setVisible(true);</span>
<span class="nc" id="L351">      nameError.setText(e.getMessage());</span>
    }
<span class="nc" id="L353">  }</span>
  
  /**
   * Goes to the all projects page without saving the current project. A confirmation popup when
   * the delete button is pressed.
   */
  public void deleteProject() {
<span class="nc" id="L360">    Alert alert = new Alert(Alert.AlertType.CONFIRMATION);</span>
<span class="nc" id="L361">    alert.setTitle(&quot;Delete project&quot;);</span>
<span class="nc" id="L362">    alert.setHeaderText(&quot;Are you sure you want to delete this project?&quot;);</span>
<span class="nc" id="L363">    alert.setContentText(&quot;This action cannot be undone.&quot;);</span>
    
<span class="nc" id="L365">    Optional&lt;ButtonType&gt; result = alert.showAndWait();</span>
    
<span class="nc bnc" id="L367" title="All 4 branches missed.">    if (result.isPresent() &amp;&amp; result.get() == ButtonType.OK) {</span>
      try {
<span class="nc" id="L369">        System.out.println(&quot;Deleting project&quot;);</span>
<span class="nc" id="L370">        Parent root = FXMLLoader.load(</span>
<span class="nc" id="L371">            Objects.requireNonNull(getClass().getResource(&quot;/AllProjects.fxml&quot;)));</span>
<span class="nc" id="L372">        BudgetAndAccountingApp.setRoot(root);</span>
<span class="nc" id="L373">      } catch (IOException e) {</span>
<span class="nc" id="L374">        e.printStackTrace();</span>
      }
    }
<span class="nc" id="L377">  }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.7.202105040129</span></div></body></html>